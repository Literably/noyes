#!/usr/bin/env ruby
# vim: set filetype=ruby :
ROOT = File.dirname(File.dirname(__FILE__))
$: << "#{ROOT}/lib" << "#{ROOT}/ship"

require 'optparse'
options = {:port => 2348, :address => '174.129.244.159',
           :rate => '16k', :bits => '16'}
OptionParser.new do |opt|
  opt.banner = 'Usage: nrec [options] file1 file2 ...'
  opt.on '-v', '--verbose', 'Output more information' do 
    options[:verbose] = true
  end
  options[:implementation] = :ruby
  opt.on '--implementation [IMP]', [:java, :c, :ruby],
         'Select the implementation (java, c, ruby).' do |implementation|
    options[:implementation] = implementation
  end
  opt.on '-c', '--clang', 'Use c implementation' do
    options[:implementation] = :c
  end
  opt.on '-p', '--port [PORT]', 'Port' do |port|
    options[:port] = port
  end
  opt.on '-a', '--address [ADDRESS]', 'Internet address' do |address|
    options[:address] = address
  end
  opt.on '-b', '--bits [BITS]', 'Bit bits' do |bits|
    options[:bits] = bits
  end
  opt.on '-r', '--rate [RATE]', 'Sampling rate' do |rate|
    options[:rate] = rate
  end
  opt.on '--pcm', 'PCM' do
    options[:pcm] = true
  end
  opt.on( '-h', '--help', 'Display this screen' ) do
    puts opt
    exit
  end
end.parse!

# Must set implementation specific library path before requiring libraries.
case options[:implementation]
when :c
  if RUBY_PLATFORM == 'java'
    puts "The Java implementation is not accessable from Ruby, only JRuby."
    puts "You'll need to check your environment carefully.  If you've"
    puts "installed this gem under both ruby and jruby and both are in"
    puts "your current environment you may have created a conflict."
    puts "You must make sure the Ruby path preceeds the JRuby path."
    exit
  end
  puts "Using C implementation" if options[:verbose]
  require 'noyes_c'
  include NoyesC
when :java
  if RUBY_PLATFORM != 'java'
    puts "The Java implementation is not accessable from Ruby, only JRuby."
    puts "You'll need to check your environment carefully.  If you've"
    puts "installed this gem under both ruby and jruby and both are in"
    puts "your current environment you may have created a conflict."
    puts "You must make sure the JRuby path preceeds the Ruby path."
    exit
  end
  puts "Using Java implementation" if options[:verbose]
  require 'noyes_java'
  include NoyesJava
when :ruby
  if options[:verbose]
    if RUBY_PLATFORM == 'java'
      puts "Using pure ruby implementation under JRuby #{RUBY_VERSION}."
    else
      puts "Using pure ruby implementation under Ruby #{RUBY_VERSION}."
    end
  end

  require 'noyes'
  include Noyes
end
require 'socket'

def recognize file, options
  TCPSocket.open(options[:address], options[:port]) do |client|
    if options[:pcm]
      send_incremental_pcm file, client, client, options[:bits], options[:rate]
    else
      send_incremental_features file, client, client
    end
  end
end

ARGV.each do |file|
  puts "recognizing file #{file}" if options[:verbose]
  result = recognize file, options
  puts "\n#{result}"
end
